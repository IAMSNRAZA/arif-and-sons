<div class="container card">
  <h2>Create a New Order</h2>
  <%= form_for @order do |form| %>
    <div class="form-group">
      <%= form.label :customer_id, "Customer" %>
      <%= form.select :customer_id, options_for_select(Customer.all.map { |customer| [customer.name, customer.id] }), {}, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= form.label :order_items_attributes, "Order Items" %>
      <div id="order-items">
        <%= form.fields_for :order_items do |order_item_form| %>
          <%= render "order_item_fields", form: order_item_form %>
        <% end %>
        <div class="links">
          <%= link_to_add_association "Add Item", form, :order_items, partial: "order_item_fields", locals: { form: form }, class: 'nested_fields_btn btn btn-outline-primary rounded float-right' %>
        </div>
      </div>
    </div>

    <div class="form-group">
      <%= form.label :total %>
      <%= form.number_field :total, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= form.label :payed_amount %>
      <%= form.number_field :payed_amount, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= form.label :remaining_amount %>
      <%= form.number_field :remaining_amount, class: "form-control" %>
    </div>


    <div class="actions">
      <%= form.submit "Create Order", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<%# <script>
  document.addEventListener("turbolinks:load", function() {
    function updateOrderTotal() {
      var total = 0;
      document.querySelectorAll(".order-item-fields").forEach(function(orderItem) {
        var quantity = orderItem.querySelector(".quantity-field").value;
        var price = orderItem.querySelector(".price-field").value;
        var itemTotal = quantity * price;
        total += itemTotal;
      });
      document.querySelector("#order_total").value = total.toFixed(2);
    }

    document.querySelector(".order-items").addEventListener("cocoon:after-insert", function(e, insertedItem) {
      var productSelect = insertedItem.querySelector(".product-select");
      var quantityField = insertedItem.querySelector(".quantity-field");
      var priceField = insertedItem.querySelector(".price-field");

      productSelect.addEventListener("change", function() {
        var price = parseFloat(productSelect.querySelector("option:selected").dataset.price);
        priceField.value = price.toFixed(2);
        updateOrderTotal();
      });

      quantityField.addEventListener("change", function() {
        updateOrderTotal();
      });
    });
  });
</script> %>